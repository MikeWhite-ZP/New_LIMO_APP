# ==================================================================
# USA LUXURY LIMO - PRODUCTION DEPLOYMENT
# Coolify-Ready Docker Compose Configuration
# ==================================================================
# This file orchestrates both backend and frontend services
# for production deployment on Coolify or self-hosted Docker
#
# Services:
#   - backend: Express API + Admin Portals (port 5000)
#   - frontend: Public Website (port 80)
# ==================================================================

version: "3.8"

services:
  # ================================================================
  # BACKEND SERVICE - API, Auth, Admin Portals
  # ================================================================
  backend:
    build:
      context: ./backend
      dockerfile: deployment/Dockerfile
    
    container_name: usa-limo-backend
    restart: unless-stopped
    
    # Environment Variables - Configure in Coolify UI
    environment:
      # Application
      - NODE_ENV=production
      
      # Database (REQUIRED - External PostgreSQL)
      # Example: postgresql://user:pass@neon.tech:5432/dbname
      - DATABASE_URL=${DATABASE_URL}
      
      # Security (REQUIRED)
      - SESSION_SECRET=${SESSION_SECRET}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      
      # Domains & CORS (REQUIRED)
      - DOMAIN=${DOMAIN}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
      - ADMIN_PANEL_HOSTS=${ADMIN_PANEL_HOSTS}
      - BASE_URL=${BASE_URL}
      - API_BASE_URL=${API_BASE_URL}
      - VITE_API_BASE_URL=${VITE_API_BASE_URL}
      
      # Object Storage (REQUIRED)
      - MINIO_ENDPOINT=${MINIO_ENDPOINT}
      - MINIO_PORT=${MINIO_PORT:-9000}
      - MINIO_USE_SSL=${MINIO_USE_SSL:-true}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
      - MINIO_BUCKET=${MINIO_BUCKET:-luxury-limo}
      
      # Payment Processing (REQUIRED)
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - VITE_STRIPE_PUBLIC_KEY=${VITE_STRIPE_PUBLIC_KEY}
      - PAYPAL_CLIENT_ID=${PAYPAL_CLIENT_ID}
      - PAYPAL_CLIENT_SECRET=${PAYPAL_CLIENT_SECRET}
      - PAYPAL_MODE=${PAYPAL_MODE:-live}
      - SQUARE_ACCESS_TOKEN=${SQUARE_ACCESS_TOKEN}
      - SQUARE_LOCATION_ID=${SQUARE_LOCATION_ID}
      - SQUARE_ENVIRONMENT=${SQUARE_ENVIRONMENT:-production}
      
      # SMS Notifications (REQUIRED)
      - TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID}
      - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN}
      - TWILIO_PHONE_NUMBER=${TWILIO_PHONE_NUMBER}
      
      # Email Notifications (REQUIRED)
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_SECURE=${SMTP_SECURE:-false}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - EMAIL_FROM=${EMAIL_FROM}
      
      # APIs (REQUIRED)
      - TOMTOM_API_KEY=${TOMTOM_API_KEY}
      - AERODATABOX_API_KEY=${AERODATABOX_API_KEY}
      
      # Authentication (Optional - Replit only)
      - ISSUER_URL=${ISSUER_URL}
      - CLIENT_ID=${CLIENT_ID}
      - CLIENT_SECRET=${CLIENT_SECRET}
      - REPLIT_DOMAINS=${REPLIT_DOMAINS}
    
    # Health Check
    healthcheck:
      test: ["CMD", "node", "healthcheck.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Caddy Labels for Coolify (automatic SSL, routing)
    labels:
      # Backend API
      - "caddy=https://api.${DOMAIN}"
      - "caddy.encode=zstd gzip"
      - "caddy.reverse_proxy={{upstreams 5000}}"
      - "caddy.header=-Server"
      - "caddy.header.X-Frame-Options=SAMEORIGIN"
      - "caddy.header.X-Content-Type-Options=nosniff"
      - "caddy.header.X-Content-Type-Options=nosniff"
      
      # Admin Panel (same backend, different domain)
      - "caddy_1=https://admin.${DOMAIN}"
      - "caddy_1.encode=zstd gzip"
      - "caddy_1.reverse_proxy={{upstreams 5000}}"
      - "caddy_1.header=-Server"
    
    # Uncomment for manual Docker Compose testing (NOT for Coolify)
    # ports:
    #   - "5000:5000"

  # ================================================================
  # FRONTEND SERVICE - Public Website
  # ================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_BASE_URL=${VITE_API_BASE_URL}
    
    container_name: usa-limo-frontend
    restart: unless-stopped
    
    # Health Check
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    
    # Caddy Labels for Coolify (automatic SSL, routing)
    labels:
      # Main Website Domain
      - "caddy=https://${DOMAIN}"
      - "caddy.encode=zstd gzip"
      - "caddy.reverse_proxy={{upstreams 80}}"
      - "caddy.header=-Server"
      - "caddy.header.X-Frame-Options=SAMEORIGIN"
      - "caddy.header.X-Content-Type-Options=nosniff"
      
      # WWW Redirect
      - "caddy_1=https://www.${DOMAIN}"
      - "caddy_1.redir=https://${DOMAIN}{uri}"
    
    # Frontend depends on backend being healthy
    depends_on:
      backend:
        condition: service_healthy
    
    # Uncomment for manual Docker Compose testing (NOT for Coolify)
    # ports:
    #   - "80:80"

# ================================================================
# Docker Network for service communication
# ================================================================
networks:
  default:
    name: usa-limo-network
