# USA Luxury Limo - Production Deployment
# Monorepo configuration with separate backend and frontend services

version: "3.8"

services:
  # Backend Service - API + Admin Portals
  backend:
    build:
      context: ./backend
      dockerfile: deployment/Dockerfile
    
    container_name: usa-limo-backend
    restart: unless-stopped
    
    # Environment variables for backend
    environment:
      # Application
      - NODE_ENV=production
      
      # Database (Required - External PostgreSQL)
      # IMPORTANT: URL-encode special characters (? → %3F, @ → %40, # → %23)
      - DATABASE_URL=${DATABASE_URL}
      
      # Session Security (Required)
      - SESSION_SECRET=${SESSION_SECRET}
      
      # Data Encryption (Required - 32 characters)
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      
      # CORS - Frontend URL (Required)
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
      
      # Admin Panel Access Control (Required)
      - ADMIN_PANEL_HOSTS=${ADMIN_PANEL_HOSTS}
      
      # MinIO/S3 Object Storage (Required)
      - MINIO_ENDPOINT=${MINIO_ENDPOINT}
      - MINIO_PORT=${MINIO_PORT:-9000}
      - MINIO_USE_SSL=${MINIO_USE_SSL:-true}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
      - MINIO_BUCKET=${MINIO_BUCKET:-replit}
      
      # Replit Auth (if using Replit)
      - ISSUER_URL=${ISSUER_URL}
      - CLIENT_ID=${CLIENT_ID}
      - CLIENT_SECRET=${CLIENT_SECRET}
      - REPLIT_DOMAINS=${REPLIT_DOMAINS}
      
      # TomTom API (Required)
      - TOMTOM_API_KEY=${TOMTOM_API_KEY}
      
      # AeroDataBox API (Optional)
      - AERODATABOX_API_KEY=${AERODATABOX_API_KEY}
      
      # Stripe (Required)
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - VITE_STRIPE_PUBLIC_KEY=${VITE_STRIPE_PUBLIC_KEY}
      
      # PayPal (Optional)
      - PAYPAL_CLIENT_ID=${PAYPAL_CLIENT_ID}
      - PAYPAL_CLIENT_SECRET=${PAYPAL_CLIENT_SECRET}
      - PAYPAL_MODE=${PAYPAL_MODE:-live}
      
      # Square (Optional)
      - SQUARE_ACCESS_TOKEN=${SQUARE_ACCESS_TOKEN}
      - SQUARE_LOCATION_ID=${SQUARE_LOCATION_ID}
      - SQUARE_ENVIRONMENT=${SQUARE_ENVIRONMENT:-production}
      
      # Twilio SMS (Required)
      - TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID}
      - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN}
      - TWILIO_PHONE_NUMBER=${TWILIO_PHONE_NUMBER}
      
      # Email SMTP (Required)
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_SECURE=${SMTP_SECURE:-false}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - EMAIL_FROM=${EMAIL_FROM}
      
      # Application URLs
      - BASE_URL=${BASE_URL}
      - API_BASE_URL=${API_BASE_URL}
    
    # Coolify labels for backend service
    labels:
      # Backend API domain
      - "caddy=https://api.${DOMAIN:-yourdomain.com}"
      - "caddy.encode=zstd gzip"
      - "caddy.reverse_proxy={{upstreams 5000}}"
      - "caddy.header=-Server"
      - "caddy.header.X-Frame-Options=SAMEORIGIN"
      - "caddy.header.X-Content-Type-Options=nosniff"
      
      # Admin subdomain (same backend, different domain)
      - "caddy_1=https://admin.${DOMAIN:-yourdomain.com}"
      - "caddy_1.encode=zstd gzip"
      - "caddy_1.reverse_proxy={{upstreams 5000}}"
      - "caddy_1.header=-Server"
    
    # Health check
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # No ports needed - Coolify handles routing
    # For manual Docker Compose, uncomment:
    # ports:
    #   - "5000:5000"
  
  # Frontend Service - Public Website
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        # Build-time environment variable
        - VITE_API_BASE_URL=${VITE_API_BASE_URL}
    
    container_name: usa-limo-frontend
    restart: unless-stopped
    
    # Coolify labels for frontend service
    labels:
      # Main website domain
      - "caddy=https://${DOMAIN:-yourdomain.com}"
      - "caddy.encode=zstd gzip"
      - "caddy.reverse_proxy={{upstreams 80}}"
      - "caddy.header=-Server"
      - "caddy.header.X-Frame-Options=SAMEORIGIN"
      - "caddy.header.X-Content-Type-Options=nosniff"
      
      # WWW redirect
      - "caddy_1=https://www.${DOMAIN:-yourdomain.com}"
      - "caddy_1.redir=https://${DOMAIN:-yourdomain.com}{uri}"
    
    # Health check
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    
    # No ports needed - Coolify handles routing
    # For manual Docker Compose, uncomment:
    # ports:
    #   - "80:80"
    
    # Frontend depends on backend being available
    depends_on:
      backend:
        condition: service_healthy

# Optional: Define a network for service communication
networks:
  default:
    name: usa-limo-network
